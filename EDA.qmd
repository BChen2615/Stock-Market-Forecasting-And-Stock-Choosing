---
title: "Taiwan Stock Market Exploratory Data Analysis"
author: "Branden Chen"
date: last-modified
format: 
  html:
    orientation: rows
    theme: cosmo
    nav-buttons: [github]
    toc: true
    toc-location: left
---

```{python}
#| echo: false
#| title: "Import Libraries"
#| output: false
#| message: false
#| warning: false
# Import necessary libraries
import datetime as dt
import pandas as pd
import numpy as np
from yfinance.utils import auto_adjust
import plotly.express as px
import matplotlib.pyplot as plt
import seaborn as sns
import yfinance as yf
import twstock
import sqlite3
```

```{python}
#| echo: false
#| title: "Load Taiwan Stock Market Data"
#| message: false
#| warning: false

# Load Taiwan stock market data from a database
db_path = "data/twstock.db"
conn = sqlite3.connect(db_path)
query = "SELECT * FROM tw_stock_prices"
original_data = pd.read_sql_query(query, conn)
original_data["Date"] = pd.to_datetime(original_data["Date"])
original_data["Stock_ID"] = original_data["Stock_ID"].astype(int)
```

# Intro to Taiwan Stock Market Data

We are using moving average and closing price of the stock to do the prediction of the stock price. The data is collected from Yahoo Finance and stored in a SQLite database. The dataset contains historical stock prices for various companies listed on the Taiwan Stock Exchange.

```{python}
#| echo: false
#| title: "Interactive Data Table"
# Render the original_data DataFrame as an interactive table
from src import DataProcess

def graph_for_data(stock_id, duration= 365 * 5, end_date= dt.date.today()):
    filtered_data = EDA_data[
        (EDA_data["Stock_ID"] == stock_id) &
        (EDA_data["Date"] >= (pd.to_datetime(end_date) - dt.timedelta(duration))) &
        (EDA_data["Date"] <= pd.to_datetime(end_date))
    ]
    return filtered_data


EDA_data = original_data.copy()
for i in [5, 10, 20, 60, 120, 240]:
  EDA_data = DataProcess.average_price(i, EDA_data)

y_graph = ["Close", "MA_5","MA_10", "MA_20", "MA_60", "MA_120", "MA_240"]  # The selection of columns to plot
stock_id_graph = "2838"  # Stock ID for graphing

px.line(graph_for_data(2399, duration= 365), x= "Date", y= y_graph, title= f"{stock_id_graph}.tw Closing Prices with Moving Averages in TWD", labels= {"value": "Closing Price"})

```

```{python}
sid = EDA_data["Stock_ID"].unique()
trans = EDA_data.sort_values('Date', ascending= False).groupby('Stock_ID', as_index= False).head(2)
trans = trans.sort_values(['Date'])
trans = trans[["Date", "Stock_ID", "Close", "MA_5","MA_10", "MA_20", "MA_60", "MA_120", "MA_240"]]
new_trans = trans.groupby('Stock_ID', as_index= False)[["Close", "MA_5","MA_10", "MA_20", "MA_60", "MA_120", "MA_240"]].transform("pct_change")
trans = trans.join(new_trans, rsuffix= '_delta_pct')
trans = trans.dropna(subset= ["Close_delta"])
return_df = pd.DataFrame()
return_df["Stock_ID"] = sid
```

```{python}
x = EDA_data.groupby("Stock_ID").size().max()
```

```{python}
from src import DataProcess as DP

final = DP.prediction_data_processing(original_data, dt.datetime(2025,12,1))
```

```{python}
# First model, predict close price directly
import sklearn as sk
final = DP.prediction_data_processing(original_data, dt.datetime(2025,12,1))
y = original_data[original_data["Date"] == dt.datetime(2025,12,1)][["Stock_ID", "Close"]]
y = y.rename(columns= {"Close": "y"})
final = final.merge(y, on= "Stock_ID", how= "left")

y = final["y"]
X = final.drop(columns= ["Stock_ID", "y"])

X_train, X_test, y_train, y_test = sk.model_selection.train_test_split(X, y, test_size=0.2, random_state=42
)

X_train = X_train.astype('float64')
X_test = X_test.astype('float64')
y_train = y_train.astype('float64')
y_test = y_test.astype("float64")

model = sk.linear_model.LinearRegression()
model.fit(X= X_train, y= y_train)
```

```{python}
X_test['predict'] = model.predict(X_test)
X_test['actual'] = y_test
```

```{python}
X_test['residual'] = X_test['actual'] - X_test['predict']
X_test['percent_error'] = X_test['residual'] / X_test['actual']
gdf = X_test[['Close', 'actual', 'predict', 'percent_error']]
px.scatter(gdf, "Close", "percent_error")
print(model.intercept_)
print(model.coef_)
```

```{python}
# Second model, predic delta 
import sklearn as sk

final = DP.prediction_data_processing(original_data, dt.datetime(2025,12,1))
y = original_data[original_data["Date"] <= dt.datetime(2025,12,1)]
y = y.sort_values("Date", ascending= False).groupby("Stock_ID", as_index= False)[["Stock_ID", "Close"]].head(1)
y = y.rename(columns= {"Close": "y_Close"})
final = final.merge(y, on= "Stock_ID", how= "left")
final['actual'] = (final["y_Close"] - final['Close']) / final["Close"]

X = final.drop(columns= ["actual"])
y = final["actual"]

X_train, X_test, y_train, y_test = sk.model_selection.train_test_split(X, y, test_size=0.2, random_state=42
)

X_train = X_train.astype('float64')
X_test = X_test.astype('float64')
y_train = y_train.astype('float64')
y_test = y_test.astype("float64")

model = sk.linear_model.LinearRegression()
model.fit(X= X_train.drop(columns= ["Stock_ID", "Close", "y_Close"]), y= y_train)

X_test['predict'] = model.predict(X_test.drop(columns= ["Stock_ID", "Close", "y_Close"]))
X_test['actual'] = y_test
X_test['Predict_Close'] = X_test["Close"] + X_test["Close"] * X_test["predict"]
X_test['residual'] = X_test['actual'] - X_test['predict']

gdf = X_test[['Close', 'residual', 'predict', 'actual']]
px.scatter(gdf, "predict", "residual")
```
